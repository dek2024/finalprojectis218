name: CI/CD - CareerLens

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # -----------------------------
  # 1) TEST JOB (CI)
  # -----------------------------
  test:
    name: Run tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest with coverage
        env:
          DATABASE_URL_TEST: sqlite:///./test.db
        run: |
          pytest --cov=app --cov-report=xml

  # -----------------------------
  # 2) BUILD & PUSH DOCKER IMAGE
  # -----------------------------
  build:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: test   # only if tests pass

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            dankinat/careerlens:latest

  # -----------------------------
  # 3) DEPLOY TO DIGITALOCEAN VPS
  # -----------------------------
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build   # only if build (and tests) succeed

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      JSEARCH_API_KEY: ${{ secrets.JSEARCH_API_KEY }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      BACKEND_BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
      FRONTEND_BASE_URL: ${{ secrets.FRONTEND_BASE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on VPS
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

          cd /root/careerlens

          # Export environment variables for docker compose
          export DATABASE_URL='${{ env.DATABASE_URL }}'
          export OPENAI_API_KEY='${{ env.OPENAI_API_KEY }}'
          export JSEARCH_API_KEY='${{ env.JSEARCH_API_KEY }}'
          export JWT_SECRET_KEY='${{ env.JWT_SECRET_KEY }}'
          export SECRET_KEY='${{ env.SECRET_KEY }}'
          export SMTP_PASSWORD='${{ env.SMTP_PASSWORD }}'
          export BACKEND_BASE_URL='${{ env.BACKEND_BASE_URL }}'
          export FRONTEND_BASE_URL='${{ env.FRONTEND_BASE_URL }}'

          # Pull latest image for CareerLens only
          docker pull dankinat/careerlens:latest

          # Restart ONLY the CareerLens stack in /root/careerlens
          docker compose down
          docker compose up -d
          EOF
